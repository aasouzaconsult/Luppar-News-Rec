{% extends 'baseRec.html' %}
{% load i18n %}
{% load tags %}
{% load bootstrap3 %}

{% block title %}{% trans "Recommendation" %}{% endblock %}
{% block content %}
    <style>
        .ui-autocomplete-loading {
            background: white url("/static/img/load.gif") right center no-repeat;
        }

        .ui-autocomplete {
            position: absolute;
            cursor: default; /*max-*/
            width: 300px;
            overflow: auto;
            padding-right: 20px;
        }
        .ui-menu .ui-menu-item h4 {
            text-overflow: ellipsis;
            overflow: hidden;
        }
    </style>

	<div class="jumbotron">
        {% autoescape off %}{% bootstrap_messages %}{% endautoescape %}

        <span class="text-center">
          <h1 class="logo"><a href="/recommender">Lu<i class="glyphicon glyphicon-search icon-flipped" style="color: gray"><i class="glyphicon glyphicon-search" style="width: 11px;right: 45px;color: black;"></i></i>ar News-Rec</a></h1>

          <!--{% trans "Receba notícias por E-mail:" %} <input type="text" name="email" size="40"> -->
          <br><br>
        </span>

        <span class="text-center">
           <form class="form-horizontal" action="/search_recomm" method="get">
                <!-- Aonde tá a barra de pesquisa
                <div class="row row-eq-height">
                    <div class="col-xs-12 col-sm-3 col-md-3 vcenter">
                        <h1 class="logo"><a href="/">Lu<i class="glyphicon glyphicon-search icon-flipped" style="color: gray"><i class="glyphicon glyphicon-search" style="width: 10px;right: 45px;color: black;"></i></i>ar</a></h1>
                    </div>

                    <div class="col-xs-12 col-sm-9 col-md-9 vcenter">
                        <span class="hidden-xs">
                            <br />
                        </span>
                        <div class="input-group form-group-lg">
                              <input type="search" id="search_query" name="q" required="true" class="form-control clearable" placeholder="{% trans "Search" %}..." value="{{ query_text }}" />
                              <input type="hidden" id="id_query" name="qid" value="{{ qid | default_if_none:'' }}" />
                              <input type="hidden" id="id_page" name="page" value="1" />
                              <span class="input-group-btn">
                                <button class="btn btn-primary btn-lg" type="submit"><i class="glyphicon glyphicon-search"></i></button>
                              </span>
                        </div>
                    </div>
                </div>
                -->

                <div class="panel-group">
                  <div class="panel panel-default">
                    <div id="collapse1" class="panel-collapse collapse in">
                      <div class="panel-body">
                              <div class="form-group form-group">

                                      {# Aqui fica a opção das Coleções #}

                                      <div class="col-sm-2 col-md-2">
                                          <label class="control-label">{% trans "Coleção" %}</label>
                                          <select id="r_source_select" name="r_source_select" class="form-control">
                                              <option value="z12" {% if 'z12' == r_source_select %} selected {% endif %}>Z12News</option>
                                              <option value="z5" {% if 'z5' == r_source_select %} selected {% endif %}>Z5News</option>
                                              <option value="z5br" {% if 'z5br' == r_source_select %} selected {% endif %}>Z5News Brasil</option>
                                            {% comment %}  {% for source in source_list %}
                                                <option value="{{ source.slug }}" {% if source.slug == r_source_select %} selected {% endif %}>{{ source.name }}</option>
                                              {% endfor %}{% endcomment %}
                                          </select>
                                      </div>
                                      {# Aqui fica a opção das Representações de Documentos #}
                                      <div class="col-sm-2 col-md-2">
                                          <label class="control-label">{% trans "Representação" %}</label>
                                          {# Ver onde referencia e mudar nome query_processor #}
                                          <select id="doc_recomm" name="doc_recomm" class="form-control">
                                              <option value="ft" {% if 'ft' == doc_recomm_select %} selected {% endif %}>FastText +E2V_IDF</option>
                                              <option value="w2v" {% if 'w2v' == doc_recomm_select %} selected {% endif %}>Word2Vec +E2V_IDF</option>
                                              <option value="bow" {% if 'bow' == doc_recomm_select %} selected {% endif %}>BoW</option>
                                              {% comment %}{% for query_processor in query_processor_list %}
                                                <option value="{{ query_processor.slug }}" {% if query_processor.slug == query_processor_select %} selected {% endif %}>{{ query_processor.name }}</option>
                                              {% endfor %}{% endcomment %}
                                          </select>
                                      </div>
                                      {# Aqui fica a opção de Classificadores#}
                                      <div class="col-sm-2 col-md-2">
                                          <label class="control-label">{% trans "Classificador" %}</label>
                                          {# Ver onde referencia e mudar nome search_model #}
                                          <select id="class_model" name="class_model" class="form-control">
                                              <option value="svm" {% if 'svm' == class_model_select %} selected {% endif %}>SVM (RBF)</option>
                                              <option value="rf" {% if 'rf' == class_model_select %} selected {% endif %}>Random Forest (RF)</option>
                                              {% comment %}{% for search in search_list %}
                                                <option value="{{ search.slug }}" {% if search.slug == search_model_select %} selected {% endif %}>{{ search.name }}</option>
                                              {% endfor %}{% endcomment %}
                                          </select>
                                      </div>
                                  <div id="list_source_div" >

                                  </div>
                                     <div class="col-sm-4 col-md-4">
                                          <label class="control-label">{% trans "Receba notícias por E-mail:" %}</label>
                                          <div class="text-center">
                                            <input type="text" name="email" size="40">
                                          </div>
                                      </div>
                                      <div class="col-sm-2 col-md-2">
                                          <label class="control-label">{% trans "Métricas" %}</label>
                                          <div class="text-center">
                                            <input type="checkbox" name="metrics_search">
                                          </div>
                                      </div>
                                    <div class="col-sm-4 col-md-4">
                                      <div class="col-sm-6 col-md-26">
                                          <label class="control-label">{% trans "Recomendar" %}</label>
                                          <div class="text-center">
                                            <button class="btn btn-primary btn-lg" type="submit" name="recomm" value="recomm"><i class="glyphicon glyphicon-search"></i></button>
                                          </div>
                                      </div>
                                      <div class="col-sm-6 col-md-6">
                                          <label class="control-label">{% trans "Baixar e Recomendar" %}</label>
                                          <div class="text-center">
                                            <button class="btn btn-success btn-lg" type="submit" name="recomm" value="recomm_update" ><i class="glyphicon glyphicon-search"></i></button>
                                          </div>
                                      </div>
                                    </div>
                              </div>
                      </div>
                    </div>

                    {# Detalhando quando selecionado a opção: Métricas (tela abaixo do grid com as opções) #}
                    <div id="collapse2" class="panel-collapse panel-primary collapse {% if  metrics_search == 'on' and total_docs > 1 %} in {% endif %}">
                    {% if metrics_search == 'on' and metrics %}
                        <div class="panel-heading ">Métricas</div>
                      <div class="panel-body">
                                <div class="col-md-6">
                                    <ul class="list-group text-left">
                                        <textarea rows="10" cols="100%" style="font-family: Courier New, Courier, monospace">
                                            {{ metrics }}
                                        </textarea>
                                    </ul>
                                </div>

                      </div>
                    {% endif %}
                    </div>
                  </div>
                </div>
            </form>

            <span style="display: none">
                <div id="z12" class="topiclass col-sm-2 col-md-2">
                                          <label class="control-label">{% trans "Tópicos" %}</label>
                                          <div class="text-left">
                                            <input type="checkbox" name="topics[]" value="sportsnews">
                                              <label for="sportsnews">sportsnews</label> </br>
                                              <input type="checkbox" name="topics[]" value="politicsNews">
                                              <label for="politicsNews">politicsNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="technologyNews">
                                              <label for="technologyNews">technologyNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="PersonalFinance">
                                              <label for="PersonalFinance">PersonalFinance</label> </br>
                                              <input type="checkbox" name="topics[]" value="brazil-news">
                                              <label for="brazil-news">brazil-news</label> </br>
                                              <input type="checkbox" name="topics[]" value="aerospace-defense">
                                              <label for="aerospace-defense">aerospace-defense</label> </br>
                                              <input type="checkbox" name="topics[]" value="autos">
                                              <label for="autos">autos</label> </br>
                                              <input type="checkbox" name="topics[]" value="commoditiesNews">
                                              <label for="commoditiesNews">commoditiesNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="fundsNews">
                                              <label for="fundsNews">fundsNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="foreignexchangeNews">
                                              <label for="foreignexchangeNews">foreignexchangeNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="healthnews">
                                              <label for="healthnews">healthnews</label> </br>
                                              <input type="checkbox" name="topics[]" value="environmentnews">
                                              <label for="environmentnews">environmentnews</label> </br>
                                          </div>
                                      </div>
                <div id="z5" class="topiclass col-sm-2 col-md-2" style="display: none">
                                          <label class="control-label">{% trans "Tópicos" %}</label>
                                          <div class="text-left">
                                            <input type="checkbox" name="topics[]" value="sportsNews">
                                              <label for="sportsNews">sportsNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="politicsNews">
                                              <label for="politicsNews">politicsNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="technologyNews">
                                              <label for="technologyNews">technologyNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="PersonalFinance">
                                              <label for="PersonalFinance">PersonalFinance</label> </br>
                                              <input type="checkbox" name="topics[]" value="brazil-news">
                                              <label for="brazil-news">brazil-news</label> </br>
                                          </div>
                                      </div>
                <div id="z5br" class="topiclass col-sm-2 col-md-2" style="display: none">
                                          <label class="control-label">{% trans "Tópicos - BR" %}</label>
                                          <div class="text-left">
                                            <input type="checkbox" name="topics[]" value="esporteNews" >
                                              <label for="esporteNews">esporteNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="politicaNews">
                                              <label for="politicaNews">politicaNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="tecnologiaNews">
                                              <label for="tecnologiaNews">tecnologiaNews</label> </br>
                                              <input type="checkbox" name="topics[]" value="financaPessoal">
                                              <label for="financaPessoal">financaPessoal</label> </br>
                                              <input type="checkbox" name="topics[]" value="educacaonews">
                                              <label for="educacaonews">educacaonews</label> </br>
                                          </div>
                                      </div>
            </span>
        </span>
        {# Painel de Retorno - Documentos Retornados #}
        {% if total_docs > 1 %}
        <div class="panel panel-default">
            <div class="panel-heading">
                {% if document_related %}<span class="text-right"><b>{% trans "Related documents" %}:</b> "<i>{{ document_related.name }}</i>" ,</span>{% endif %}
                <b>{{ total_docs }}</b> {% trans "results" %} {% trans "in" %} <b>{{ total_time }}</b> {% trans "seconds" %}
            </div>
            <div class="panel-body">

                     <div class="list-group {% if free_search == 'on' or not documents_relevant %} col-md-12 {% else  %} col-md-6 {% endif %}">
                     <div class="panel-heading"><i>{% trans "Retrieval" %}</i></div>
                         {% for doc in documents %}
                             <span class="list-group-item" style="background-color: #ffffe6">
                                    <span class="badge">{{forloop.counter}}º</span>
                                    <h4><a href="{{ doc.lk }}" target="_blank">[{{ doc.label }}] - {{ doc.dt }}</a></h4>

                                    <p>{{ doc.doc }}...</p>
{#                                    <a href="{% relative_url doc.idd 'drid' request.GET.urlencode %}&page=1" class="" title="{% trans "Relevance Feedback" %}"><i class="glyphicon glyphicon-star"></i> {% trans "Related documents" %}...</a>#}

                             </span>
                         {% endfor %}
                     </div>

{#                    {% if free_search != 'on' and documents_relevant %}#}
{#                        <div class="list-group {% if free_search == 'on' %} col-md-12 {% else  %} col-md-6 {% endif %}">#}
{#                        <div class="panel-heading"><i>{% trans "Relevant" %}</i></div>#}
{#                             {% for doc in documents_relevant %}#}
{#                                 <span class="list-group-item" style="background-color: #e6ffe6">#}
{#                                        <span class="badge">{{forloop.counter}}º</span>#}
{#                                        <h4><a href="/document/{{ r_source_select }}/{{ doc.idd }}">DOC {{ doc.idd }}</a></h4>#}
{#                                        <p>{{ doc.prev_text}}...</p>#}
{#                                        <a href="{% relative_url doc.idd 'drid' request.GET.urlencode %}&page=1" class="" title="{% trans "Relevance Feedback" %}"><i class="glyphicon glyphicon-star"></i> {% trans "Related documents" %}...</a>#}
{#                                 </span>#}
{#                             {% endfor %}#}
{#                         </div>#}
{#                    {% endif %}#}
                    <div class="col-md-12">
                        {% bootstrap_pagination documents url="/search_recomm?"|add:request.GET.urlencode size="large" pages_to_show="9" %}
                    </div>
            </div>
        </div>
        {% elif request.path == '/search_recomm' %}
            <div class="panel panel-default">
                <div class="panel-body">
                    <div class="notfound">
                        {% blocktrans %}
                            <p>
                                Sua busca não encontrou notícias com esses tópicos.
                            </p>
                            <p>
                            <ul>
                                <li>Verifique os filtros</li>
                                <li>Seleciones outros tópicos</li>
                            </ul>
                            </p>
                        {% endblocktrans %}
                    </div>
                </div>
            </div>
        {% endif %}

        <hr class="my-4">

        {# Botão Voltar #}
        <p class="lead">
          <a class="btn btn-primary btn-lg" href="#" onclick="history.back()" role="button">{% trans "Back" %}</a>
        </p>

    </div>

{# Falta Entender #}
<script type="application/javascript">
$(document).ready(function() {

        $("#id_query").change(function(){
            $( "#id_query" ).val();
        })


        {% autoescape off %}
            var r_source_select = ''
            try {
                r_source_select = {% if r_source_select %} '{{ r_source_select }}' {% else %} 'z12' {% endif %};
            }catch(err){

            }
        {% endautoescape %}

        console.log('{{ request.path }}');

        $('#'+r_source_select).css('display','block');
        $('#list_source_div').html($('#'+r_source_select).clone());


        $('#r_source_select').change(function () {
                $('.topiclass').css('display','none');
                $('#'+$(this).val()).css('display','block');
                $('#list_source_div').html($('#'+$(this).val()).clone())
        });

        {% autoescape off %}
            var topics_select = []
            try {
                topics_select = {% if topics_select %} {{ topics_select }} {% else %} [] {% endif %};
            }catch(err){

            }
        {% endautoescape %}

        $( "input[type=checkbox]").each(
            function() {
                for(var i=0;i<topics_select.length;i++){
                    if ($(this).val() == topics_select[i])
                        $(this).prop( "checked", true );
                }
            }
        );


        $( "#search_query" )
            .on( "keydown", function( event ) {
            if ( event.keyCode === $.ui.keyCode.TAB &&
                $( this ).autocomplete( "instance" ).menu.active ) {
              event.preventDefault();
            }
          })
            .autocomplete({
                  minLength: 0,
                  source: function( request, response ) {
                    $.ajax( {
                      url: "query_preview",
                      dataType: "json",
                      data: {
                        q: request.term,
                          s: $( "#r_source_select" ).find(":selected").val()
                      },
                      success: function( data ) {
                        response( data );
                      }
                    } );
                  },
                change: function (event, ui) {
                    if(!ui.item){
                        if(!$("[name='free_search']").bootstrapSwitch('state')){
                            $("#search_query").val("");
                        }
                    }
                },
                select: function( event, ui ) {
                    console.log( "Selected: " + ui.item.fields.text);
                    this.value = ui.item.fields.text;
                    $( "#id_query" ).val(ui.item.fields.idq);
                    return false;
                }
            } ).focus(function(){
                $(this).autocomplete("search");
            }).change(function(){
                $( "#id_query" ).val("");
            }).autocomplete( "instance" )._renderItem = function( ul, item ) {
                  var length = 100
                  var re = new RegExp("^" + this.term) ;
                  var t = item.fields.text.replace(re,"<span style='font-weight:bold;color:Blue;'>" +
                          this.term +
                          "</span>");
                  return $( "<li></li>" )
                      .data( "item.autocomplete", item )
                      .append( "<h4 style='overflow-x:hidden; text-overflow: ellipsis; white-space: nowrap;'>" + t +  "</h4>" )
                      .appendTo( ul );
            };

            var status_free =  '{{ free_search }}'=='on'? true : false;
            var status_metrics =  '{{ metrics_search }}'=='on'? true : false;


		    $("[name='free_search']").bootstrapSwitch({

				 handleWidth:'50px',
				 labelWidth:'50px',
				 onText:'{% trans "Yes" %}',
				 offText:'{% trans "No" %}',
				 inverse:false,
				 state:true,
				 onColor:'success',
				 offColor:'info',
            });

		    $("[name='free_search']").bootstrapSwitch('state',status_free);

		    $("[name='metrics_search']").bootstrapSwitch({

				 handleWidth:'50px',
				 labelWidth:'50px',
				 onText:'{% trans "Yes" %}',
				 offText:'{% trans "No" %}',
				 inverse:false,
				 state:false,
				 onColor:'success',
				 offColor:'info',
            });

		    $("[name='metrics_search']").bootstrapSwitch('state',status_metrics);


        });
</script>


{% endblock %}